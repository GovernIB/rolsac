<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="rolsac-1.0.4" default="usage">
     
	<property name="rolsac.target" value="${ant.project.name}"/>
	<property name="home" value="."/>
	<property file="${home}/build.${user.name}.properties" />
	<property file="${home}/build.${rolsac.target}.properties"/>
	<property file="${home}/config.properties"/>
	<property name="doc" value="${home}/doc"/>
	<property name="components" value="${home}/moduls"/>
	<property name="etc" value="${home}/etc"/>
	<property name="etc.jboss" location="${etc}/jboss-${jboss.version}"/>
	
	<property name="lib" value="${home}/lib"/>
	<property name="lib.caib" location="${lib}/caib"/>
	<property name="axis" location="${lib}/axis"/>
	
	<property name="output.dir" location="${home}/output"/>
	<property name="product.dir" location="${output.dir}/product"/>
	<property name="moduls.dir" location="${output.dir}/moduls"/>
	<property name="doc.dir" location="${output.dir}/doc"/>
	
	<property name="projecte.name.rolsac" value="rolsac"/>	

	<property name="etc.approlsac" value="${etc}/approlsac"/>

	<property environment="env"/>

	<condition property="db.oracle" value="true">
	  		<contains string="${hibernate.dialect}" substring="oracle" casesensitive="false"/>
	</condition>

	
	<!-- se incluyen targets de ant-contrib --> 

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	  <classpath>
	    <pathelement location="${lib}/ant-contrib-0.6.jar"/>
	  </classpath>
	</taskdef>

  <!-- *******************   TASQUES GENERALS  ****************************   -->
  <!-- ====================================================================== -->
  <!-- usage                                                                                                                           -->
  <!-- ====================================================================== -->
  <target name="usage">
    <echo>
		---------------------------------------------------------------------------------------------------
		Tasques del projecte :
	
		****** Tasques d'ajuda :
	
		usage : aquesta ajuda
		properties : mostra les propietats definides
        info              : usage + properties

        ****** Tasques de preparació :
        prepare           : crea l'estructura de directoris necessaria per la construcció de l'aplicació
	
        ****** Tasques d'actualització de components :
	    update.extractor  : actualitza eines de text
        update.model      : actualitza el model de dades
	    update.persistence: actualitza la capa de persistencia
        update.XDOCLET    : update.extractor + update.model + update.persistence

	    update.integracion: actualitza la capa d'integració
	    update.back       : actualitza el mòdul web legacy de backoffice
	    update.ws         : actualitza el mòdul web de webservices
	    update.traspasboib: actualitza el mòdul traspas-boib

		****** Tasques de documentacio i control
	
	    test.unitario     : executa els tests unitaris
	    doc               : genera la documentació de tots els mòduls
	
		****** Tasques de construccio :
	    assemble01ROLSAC  : construeix el ear amb tots els components existents
	    main01ROLSAC      : construeix tota l'aplicacio
	    clean             : esborra els directoris de treball
	    deploy01ROLSAC    : copia el ear al directori de deploy
		---------------------------------------------------------------------------------------------------
      </echo>
  </target>
  
  
  <!-- ================================================================== -->
  <!-- properties                                                                                                                     -->
  <!-- ================================================================== -->
  <target name="properties" description="Muestra las propiedades del sistema">
	<echo>
		---------------------------------------------------------------------------------------------------
		Propietats del sistema:

		home=${home}
		components=${components}
		product.dir=${product.dir}
		lib=${lib}
		doc=${doc}
        ant.file=${ant.file}
        ant.version=${ant.version}
        ant.project.name=${ant.project.name}
        ant.java.version=${ant.java.version}
		---------------------------------------------------------------------------------------------------
	</echo>
	<echoproperties/>
  </target>


  <target name="clean" description="Destruye los directorios de trabajo">
    <delete dir="${output.dir}" quiet="yes"/>
  </target>

  <!-- ================================================================== -->
  <!-- info                                                                                                                               -->
  <!-- ================================================================== -->
  <target name="info" depends="usage,properties"/>


  <!-- ================================================================== -->
  <!-- prepare                                                                                                                         -->
  <!-- ================================================================== -->
  <target name="prepare" description="Crea los directorios necesarios para la construcción de la aplicación">
  	<mkdir dir="${output.dir}"/>
     <mkdir dir="${product.dir}"/>
     <mkdir dir="${moduls.dir}"/>
     <mkdir dir="${doc.dir}"/>
  </target>

  <!-- ================================================================== -->
  <!-- doc                                                                                                                        -->
  <!-- ================================================================== -->
  <target name="doc" depends="prepare" description="Genera la documentación">
  	<antcall target="propagate">
     	<param name="task" value="doc"/>
     </antcall>
  </target>



  <!-- ================================================================== -->
  <!-- update                                                                                                                     -->
  <!-- ================================================================== -->
  
	<target name="update.XDOCLET" description="Actualiza los módulos que generan clases con XDOCLET.">
		<antcall target="update.extractor"/>
		<antcall target="update.model"/>
		<antcall target="update.persistence"/>
	</target>
	
	<target name="update.utils" description="Actualizar utilidades">
	  	<echo>UTILS</echo>
		<ant dir="moduls/utils" target="main" inheritall="false">
			<propertyset>
		   		<propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	
	<target name="update.extractor" description="Actualizar herramientas de texto">
		<echo>EXTRACTOR</echo>
		<ant dir="moduls/extractor" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<target name="update.model" description="Actualizar el modelo de datos">
		<echo>MODEL</echo>
		<ant dir="moduls/model" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<target name="update.persistence" description="Actualizar la capa de persistencia">
		<echo>PERSISTENCE</echo>
		<ant dir="moduls/persistence" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<target name="update.integracion" description="Actualizar la capa de integracion">
		<echo>INTEGRACION</echo>
		<ant dir="moduls/integracion" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<target name="update.back" description="Actualizar el modulo web legacy de backoffice">
		<echo>BACK</echo>
		<ant dir="moduls/back" target="main" inheritall="false">
			<propertyset>
		   		<propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<target name="update.ws" description="Actualitar el mdulo web de webservices">
		<echo>WS</echo>
		<ant dir="moduls/ws" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	<!--Traspas boib afegit marilen-->
    <target name="update.traspasboib" description="Actualitar el mdulo traspas-boib">
		<echo>TRASPASBOIB</echo>
		<ant dir="moduls/traspas-boib" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>


	<!--Oracle afegit ejaen@dgtic -->
    <target name="update.oracle" description="Actualitar el modulo oracle" if="db.oracle">
    	
	  	<echo>ORACLE</echo>
		<ant dir="moduls/oracle" target="main" inheritall="false">
			<propertyset>
			   <propertyref name="rolsac.target"/>
			</propertyset>
		</ant>
	</target>

	  <!-- ================================================================== -->
	  <!-- test.unitario    Executa els tests unitaris                        -->
	  <!-- ================================================================== -->


	  <target name="test.unitario">
	  	
	  		<echo> COMMON </echo>
	  		<ant dir="test/common" target="main" inheritall="false"/>
			<ant dir="moduls/extractor" target="test.unitario" inheritall="false"/>
			<ant dir="moduls/model" target="test.unitario" inheritall="false"/>
		  	<ant dir="moduls/persistence" target="test.unitario" inheritall="false"/>
	  		<ant dir="moduls/integracion" target="test.unitario" inheritall="false"/>
	  	
	  		<if><equals arg1="${db.oracle}" arg2="true"/>
	  			<then>
	  				<echo> ORACLE </echo>
		  			<ant dir="moduls/oracle" target="test.unitario" inheritall="false"/>
		  		</then>
	  		</if>
	  		<echo> BACK </echo>
	  		<ant dir="moduls/back" target="test.unitario" inheritall="false"/>
	  	
	  </target>	
	 	


	 <target name="make.application.xml">
	 	
		<delete file="${output.dir}/application.xml"/>
			
		 <concat destfile="${output.dir}/application.xml" append="true" fixlastline="true">
		    <filelist dir="${etc.approlsac}" 	files="01.application.begin.xml"/>
	 		<filelist dir="moduls/extractor" 	files="appmodule.xml"/>
		 	<filelist dir="moduls/model" 		files="appmodule.xml"/>
	 		<filelist dir="moduls/integracion" 	files="appmodule.xml"/>
		 	<filelist dir="moduls/ws" 			files="appmodule.xml"/>
	 		<filelist dir="moduls/persistence" 	files="appmodule.xml"/>
		 	<filelist dir="moduls/traspas-boib" files="appmodule.xml"/>
		 	<filelist dir="moduls/utils" 		files="appmodule.xml"/>
		 	<filelist dir="moduls/back" 		files="appmodule.xml"/>
	 	</concat>
	 	
	 	
	  	<if> <equals arg1="${db.oracle}" arg2="true" />
		 <then>
		 	<concat destfile="${output.dir}/application.xml" append="true" fixlastline="true">
		 		<filelist dir="moduls/oracle" 	files="appmodule.xml"/>
		 	</concat>
		</then>
	  	</if>

		<concat destfile="${output.dir}/application.xml" append="true" fixlastline="true">
			<filelist dir="${etc.approlsac}" files="02.application.securityrole.xml"/>
			<filelist dir="${etc.approlsac}" files="03.application.end.xml"/>
		</concat>
		
	    <replace file="${output.dir}/application.xml">
	        <replacefilter token="@context.back@" value="${context.back}"/>
	        <replacefilter token="@context.ws@" value="${context.ws}"/>
	        <replacefilter token="@prefix.modul@" value="${prefix.modul}"/>
	    </replace>

	 </target>

	
  <!-- ================================================================== -->
  <!-- assemble                                                                                                                      -->
  <!-- ================================================================== -->


	<target name="assemble01ROLSAC" description="Actualiza el EAR con los componentes generados para rolsac." if="project.author">
		<delete file="${product.dir}/01${projecte.name.rolsac}.ear" quiet="yes"/>
		
		<antcall target="make.application.xml"/>

		<ear earfile="${product.dir}/01${projecte.name.rolsac}.ear" appxml="${output.dir}/application.xml" manifest="${etc.approlsac}/manifest.mf">
			
			<manifest>
				<attribute name="Version" value="${rolsac.target}"/>
				<attribute name="Built-By" value="${project.author}"/>
				<attribute name="Build-Jdk" value="${java.version}"/>
			</manifest>
	        
			<metainf dir="${etc.jboss}" includes="jboss-app.xml"/>
	
			<!-- Incluimos los .war y .jar generados con la aplicacin para rolsac-->
			
			<fileset dir="${moduls.dir}">
				<include name="${prefix.modul}-utils.jar" />
				<include name="extractor.jar" />
				<include name="model.jar" />
				<include name="integracion.war" />
				<include name="${prefix.modul}-persistence.jar" />				
				<include name="${prefix.modul}-persistence-client.jar" />
				<include name="${prefix.modul}-back.war" />
				<include name="${prefix.modul}-ws.war" />
				<include name="traspasboib.war" />
				<include name="${prefix.modul}-oracle.jar" if="db.oracle"/>
			</fileset>
			
			
			<!-- Incluimos los .jar dependientes -->
            <fileset dir="${lib}">
                <include name="hibernate2.jar" />
                <include name="ehcache.jar" />
            </fileset>
			
    	</ear>
  </target>	
	
  <!-- ================================================================== -->
  <!-- main                                                                                                                              -->
  <!-- ================================================================== -->
  
  


	  <target name="main01ROLSAC" depends="prepare" description="Realiza todo el proceso de construcción de ROLSAC">
		  <antcall target="propagate01ROLSAC"/>
	      <antcall target="assemble01ROLSAC"/>
	      <antcall target="deploy01ROLSAC"/>
	  </target>	

  <!-- ================================================================== -->
  <!-- propagate                                                                                                                     -->
  <!-- ================================================================== -->

	  <target name="propagate01ROLSAC">
	  	
	  	<antcall target="update.utils"/>

	  	<antcall target="update.extractor"/>
	  	
	  	<antcall target="update.model"/>
		
	  	<antcall target="update.persistence"/>
	  	
	  	<antcall target="update.oracle"/>
	  		
	  	<antcall target="update.integracion"/>
	  	
	  	<antcall target="update.ws"/>
	  		
	  	<antcall target="update.back"/>
	  	
	  	<antcall target="update.traspasboib"/>
	  	
	  	
	  </target>	
 	
	
  <!-- ================================================================== -->
  <!-- deploy                                                                                                                              -->
  <!-- ================================================================== -->
	

	   <target name="deploy01ROLSAC" if="deploy.dir">
          <copy verbose="true" file="${product.dir}/01${projecte.name.rolsac}.ear" todir="${deploy.dir}"/>
	   	  <echo>
	   	  		ES RECOMANA EXECUTAR test.unitario PER COMPROBAR QUE NO S'HAGI CORROMPUT FUNCIONALITAT.
	   	  </echo>
	  </target>		  	



	
</project>

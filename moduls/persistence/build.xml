<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="sac.persistence" default="main" basedir=".">


    <property name="modul" value="persistence"/>
    <property name="package" value="org.ibit.rol.sac.persistence"/>

    <property name="home.dir" location="${basedir}/../.."/>
	<property file="${home.dir}/build.${user.name}.properties" />
	<property file="${home.dir}/build.${rolsac.target}.properties"/>
	<property file="${home.dir}/default.properties"/>
    <property file="${basedir}/build.properties"/>

    <property name="output.dir" location="${home.dir}/output"/>
    <property name="modul.output.dir" location="${output.dir}/${modul}"/>
	<property name="test.output.dir" location="${output.dir}/test"/>

    <property name="lib.dir" location="${home.dir}/lib"/>
    <property name="etc.dir" location="${home.dir}/etc"/>
    <property name="xdoclet.dir" location="${lib.dir}/xdoclet123"/>

    <property name="ejb.src" location="${basedir}/src"/>
    <property name="ejb.etc" location="${basedir}/etc"/>
    <property name="ejb.doc" location="${basedir}/doc"/>
    <property name="ejb.merge.jboss" location="${ejb.etc}/merge/jboss-${jboss.version}"/>

    <property name="ejb.gen.src" location="${modul.output.dir}/gen-src"/>
    <property name="ejb.gen.etc" location="${modul.output.dir}/gen-etc"/>
    <property name="ejb.classes" location="${modul.output.dir}/classes"/>

    <property name="doc" location="${output.dir}/doc"/>
    <property name="ejb.doc.api" location="${doc}/api/${modul}"/>
    <property name="ejb.product" location="${output.dir}/moduls"/>

	<property name="hbm.dir" location="${home.dir}/moduls/model/src/org/ibit/rol/sac/model"/>

	<property name="vuds.src" location="${basedir}/vuds/src"/>

	
    <path id="ejb.class.path">
        <fileset dir="${lib.dir}">
	    	<include name="hibernate2.jar"/>
            <include name="cglib2.jar"/>
            <include name="dom4j.jar"/>
            <include name="ejb-2_0.jar"/>
            <include name="jms.jar"/>
<!--
        	<include name="lucene.jar"/>
            <include name="lucene-ibit.jar"/>
-->
   			<include name="lucene-core-2.2.0.jar"/>
   			<include name="lucene-spellchecker-2.2.0.jar"/>	
   			<include name="jericho-html-2.5.jar"/>        	
            <include name="commons-logging.jar"/>
            <include name="commons-lang-2.4.jar"/>
            <include name="commons-beanutils.jar"/>
        	<include name="axis.jar"/>
        	<include name="jaxrpc.jar"/>
        	<include name="mail.jar"/>
        	<include name="lucene-caib.jar"/>
        	<include name="htmllexer.jar"/>
        	<include name="htmlparser.jar"/>
        </fileset>
        <fileset dir="${ejb.product}">
            <include name="sac.jar"/>        	
            <include name="model.jar"/>
        	<include name="micromodel.jar"/>
        	<include name="sac-micropersistence.jar"/>
        </fileset>
     	<fileset dir="${lib.dir}/axis2-1.5">
        		<include name="**/*.jar" />
        </fileset>
     	<fileset dir="${lib.dir}/axis-1.4">
        		<include name="**/*.jar" />
        </fileset>

    </path>

    <path id="doclet.class.path">
        <path refid="ejb.class.path"/>
        <fileset dir="${lib.dir}">
            <include name="commons-collections.jar"/>
        </fileset>
        <fileset dir="${xdoclet.dir}">
            <include name="*.jar"/>
        </fileset>
    </path>

    <target name="init">
        <taskdef
            name="ejbdoclet"
            classname="xdoclet.modules.ejb.EjbDocletTask"
            classpathref="doclet.class.path"
            />
        <tstamp>
            <format property="TODAY" pattern="dd-MM-yy"/>
        </tstamp>

        <fail unless="persistence.auth.domain" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="persistence.auth.principal" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="datasource.jndi" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="hibernate.dialect" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="hibernate.show_sql" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="hibernate.cglib" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="hibernate.cache.provider_class" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="hibernate.cache.jar" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="role.system" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="role.admin" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="role.super" message="Revise los ficheros ${home.dir}/*.properties"/>
        <fail unless="role.oper" message="Revise los ficheros ${home.dir}/*.properties"/>
    	<fail unless="role.info" message="Revise los ficheros ${home.dir}/*.properties"/>
    </target>

    <!-- Crea tots els directoris de treball necessaris -->
    <target name="prepare">
        <mkdir dir="${ejb.gen.src}"/>
        <mkdir dir="${ejb.gen.etc}"/>
        <mkdir dir="${ejb.classes}"/>
        <mkdir dir="${ejb.doc.api}"/>
        <mkdir dir="${ejb.product}"/>
    </target>

    <target name="ejb.gen.all" depends="prepare,init">

    	<!-- http://xdoclet.sourceforge.net/xdoclet/ant/xdoclet/modules/ejb/EjbDocletTask.html -->
        <ejbdoclet
            destdir="${ejb.gen.src}"
            excludedtags="@version,@author"
            ejbspec="2.0"
            force="false"
            verbose="true"
            >

            <fileset dir="${ejb.src}">
                <include name="**/*EJB.java"/>
                <include name="**/*MDB.java"/>
            </fileset>

            <packageSubstitution packages="ejb" substituteWith="intf"/>
            <localinterface pattern="{0}Local"/>
            <localhomeinterface pattern="{0}LocalHome"/>
            <remoteinterface pattern="{0}"/>
            <homeinterface pattern="{0}Home"/>
            <session/>

            <utilobject cacheHomes="true" kind="physical">
                <packageSubstitution packages="ejb" substituteWith="util"/>
            </utilobject>

            <deploymentdescriptor
                clientjar="sac-${modul}-client.jar"
                xmlencoding="UTF-8"
                destdir="${ejb.gen.etc}"
                validatexml="true"
                />

            <jboss
                version="${jboss.version}"
                xmlencoding="UTF-8"
                destdir="${ejb.gen.etc}"
                mergedir="${ejb.merge.jboss}"
                validatexml="true"
                securityDomain="${persistence.auth.domain}"
                unauthenticatedPrincipal="${persistence.auth.principal}"
                />

        </ejbdoclet>
		
        <copy file="${ejb.etc}/hibernate-rolsac.cfg.xml" todir="${ejb.gen.etc}" overwrite="true"/>
    	<copy file="${ejb.etc}/email.properties" todir="${ejb.gen.etc}" overwrite="true"/>
    	
        <replace file="${ejb.gen.etc}/hibernate-rolsac.cfg.xml">
            <replacefilter token="@hibernate.jndi@" value="${hibernate.jndi}"/>
            <replacefilter token="@datasource.jndi@" value="${datasource.jndi}"/>
            <replacefilter token="@hibernate.dialect@" value="${hibernate.dialect}"/>            
            <replacefilter token="@hibernate.cache.provider_class@" value="${hibernate.cache.provider_class}"/>
           	<replacefilter token="@hibernate.query.substitutions@" value="${hibernate.query.substitutions}"/>        	
            <replacefilter token="@hibernate.show_sql@" value="${hibernate.show_sql}"/>
            <replacefilter token="@hibernate.cglib@" value="${hibernate.cglib}"/>
        </replace>
    	
    	<replace file="${ejb.gen.etc}/email.properties">
            <replacefilter token="@email.jndi@" value="${email.jndi}"/>
            <replacefilter token="@email.email@" value="${email.email}"/>            
            <replacefilter token="@email.administracion@" value="${email.administracion}"/>
        </replace>

    </target>

    <target name="ejb.compile" depends="ejb.gen.all">
        <javac
            destdir="${ejb.classes}"
            classpathref="ejb.class.path"
            debug="${javac.debug}"
            deprecation="${javac.deprecation}"
            optimize="${javac.optimize}"
        	encoding="${javac.encoding}">
            <src path="${ejb.src}"/>
			<src path="${vuds.src}"/>
            <src path="${ejb.gen.src}"/>
        </javac>
    </target>
	
		
	
    <target name="ejb.jar" depends="ejb.compile">
        <delete file="${ejb.product}/sac-${modul}.jar" quiet="yes"/>
        <jar
            jarfile="${ejb.product}/sac-${modul}.jar"
            basedir="${ejb.classes}">
            <manifest>
                <attribute name="Created-By" value="Fundaci� IBIT"/>
            </manifest>
            <metainf dir="${ejb.gen.etc}" includes="*.xml" excludes="hibernate-rolsac.cfg.xml"/>
            <fileset dir="${ejb.gen.etc}" includes="hibernate-rolsac.cfg.xml"/>
        	<fileset dir="${ejb.gen.etc}" includes="email.properties"/>
            <fileset dir="${ejb.etc}" includes="ehcache.xml" />
        </jar>
    </target>

    <target name="ejb.client" depends="ejb.compile">
        <delete file="${ejb.product}/sac-${modul}-client.jar" quiet="yes"/>
        <jar
            jarfile="${ejb.product}/sac-${modul}-client.jar"
            basedir="${ejb.classes}">
            <manifest>
                <attribute name="Created-By" value="Fundaci� IBIT"/>
            </manifest>
            <include name="**/delegate/**/*.class"/>
            <include name="**/intf/**/*.class"/>
            <include name="**/util/**/*.class"/>
        </jar>
    </target>

    <target name="ejb.javadoc" depends="ejb.gen.all">
        <javadoc
            destdir="${ejb.doc.api}"
            classpathref="ejb.class.path"
            packagenames="${package}.*"
            overview="${ejb.doc}/overview.html"
            windowtitle="API del componente ${modul}"
            doctitle="API del componente ${modul}"
            bottom="Fundaci� Ibit">
            <sourcepath>
                <pathelement path="${ejb.gen.src}"/>
                <pathelement path="${ejb.src}"/>
            </sourcepath>
            <link href="http://java.sun.com/j2se/1.4.1/docs/api/"/>
            <link href="http://java.sun.com/j2ee/sdk_1.3/techdocs/api/"/>
            <link href="http://hibernate.bluemars.net/hib_docs/api/"/>
        </javadoc>
    </target>

    <target name="doc" depends="ejb.javadoc" description="Realiza las tareas de documentaci�n"/>
    <target name="main" depends="ejb.jar,ejb.client" description="Construye el componente"/>


	<path id="hbm2ddl.class.path">
	        <fileset dir="${lib.dir}">
	            <include name="hibernate2.jar"/>
	        	<include name="ojdbc14.jar"/>
	            <include name="dom4j.jar"/>
	            <include name="commons-logging.jar"/>
	            <include name="commons-collections.jar"/>
	        	<include name="odmg-3.0.jar"/>
	   			<include name="lucene-caib.jar"/>
	        	<include name="cglib2.jar"/>
	        </fileset>
			<fileset dir="${output.dir}/moduls">
				<include name="model.jar"/>
			</fileset>
	    </path>


	<target name="schemaexport">
		<taskdef name="schemaexport"
			classname="net.sf.hibernate.tool.hbm2ddl.SchemaExportTask"
			classpathref="hbm2ddl.class.path"/>
		<schemaexport
			properties="etc/hibernate.properties"
			quiet="no"
			text="yes"
			drop="no"
			delimiter=";"
			output="schema-export.sql">
			<fileset dir="${hbm.dir}">
				<include name="*.hbm.xml"/>
				<exclude name="Archivo.hbm.xml"/>
			</fileset>
		</schemaexport>
	</target>
	
	
	<!-- llegeix els mappings del model.jar -->
	<!--
	
	Opcions [http://docs.jboss.org/hibernate/core/3.3/reference/en/html/toolsetguide.html] :
	
	-quiet	do not output the script to stdout
	-drop	only drop the tables
	-create	only create the tables
	-text	do not export to the database
	-output=my_schema.ddl	output the ddl script to a file
	-naming=eg.MyNamingStrategy	select a NamingStrategy
	-config=hibernate.cfg.xml	read Hibernate configuration from an XML file
	-properties=hibernate.properties	read database properties from a file
	-format	format the generated SQL nicely in the script
	-delimiter=;	set an end of line delimiter for the script
	
	-->
	
	<target name="schemaupdate">

		<taskdef name="schemaupdate"
			classname="net.sf.hibernate.tool.hbm2ddl.SchemaUpdateTask"
			classpathref="hbm2ddl.class.path"/>
		<schemaupdate
			properties="${basedir}/../../config_dgtic.properties"
			text="yes"
			quiet="no">
			<fileset dir="${hbm.dir}">
				<include name="*.hbm.xml"/>
				<!--exclude name="Archivo.hbm.xml"/-->
			</fileset>
		</schemaupdate>
	</target>
	<!---->
			
	
	<target   name="module.package"   depends="ejb.jar"/>
	<path       id="module.classpath"   refid="ejb.class.path"/>
	<property name="module.classes"  location="${ejb.classes}"/>
	
	<import file="../build_test.xml"/>
	
</project>

<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">

<hibernate-mapping>

    <class name="org.ibit.rol.sac.model.ProcedimientoLocal" table="RSC_PROCED" discriminator-value="procedimientoLocal">
        <cache usage="read-write"/>

        <id name="id" unsaved-value="null" column="PRO_CODI">
            <generator class="sequence">
                <param name="sequence">RSC_SEQ_ALL</param>
            </generator>
        </id>

        <discriminator column="PRO_TYPE" type="string" length="64"/>

        <property name="signatura" length="256" column="PRO_SIGNAT"/>
        <property name="fechaCaducidad" column="PRO_FECCAD"/>
        <property name="fechaPublicacion" column="PRO_FECPUB"/>
        <property name="fechaActualizacion" column="PRO_FECACT"/>
        <property name="validacion" column="PRO_VALIDA"/>
        <property name="tramite" column="PRO_TRAMIT"/>
        <property name="version" column="PRO_VERSIO"/>
        <!-- Nuevo campo INFO para informadores -->
        <!-- #351cambio info por dir electronica -->
        <property name="dirElectronica" column="PRO_INFO" length="4000"/>
        <property name="url" length="1024" column="PRO_URLEXT"/>
        <property name="orden" length="1024" column="PRO_ORDCON"/>
        <property name="orden2" length="1024" column="PRO_ORDDIR"/>
        <property name="orden3" length="1024" column="PRO_ORDSER"/>
        <property name="indicador" length="1024" column="PRO_INDICA"/>
        <property name="ventanillaUnica" length="1024" column="PRO_VENTANA"/>
        <property name="responsable" column="PRO_RESPON" length="256"/>
        <property name="taxa" length="1024" column="PRO_TAXA"/>
        <property name="codigoSIA" length="12" column="PRO_CODSIA"/>
        <property name="estadoSIA" length="1" column="PRO_ESTSIA"/>
        <property name="fechaSIA"  column="PRO_FECSIA"/>
        <property name="comun" 		column="PRO_COMUN" />
        <property name="pendienteValidar" 		column="PRO_PDTVAL" />
        <property name="mensajesNoLeidosGestor"  column="PRO_MENGES" />
        <property name="mensajesNoLeidosSupervisor" column="PRO_MENSUP" />


		<!--
		<property name="mensajesNoLeidosGestor"
        formula="( select COUNT(*) from org.ibit.rol.sac.model.ProcedimientoMensaje procMen  ) "
        type="integer" />
 		-->

        <!--
        <property name="mensajesNoLeidosSupervisor"
        formula="( select COUNT(*)  from org.ibit.rol.sac.model.ProcedimientoMensaje procMen  where procMen.idProcedimiento = id and procMensa.gestor = true and procMensa.leido = false ) "
        type="integer"  />
		-->

        <many-to-one name="organResolutori" 	 column="PRO_CODUNA_RESOL" cascade="none" foreign-key="RSC_PRO_CODUNA_RESOL_FK"/>
        <many-to-one name="unidadAdministrativa" column="PRO_CODUNA" foreign-key="RSC_PROUNA_FK"/>
        <many-to-one name="familia" 			 column="PRO_CODFAM" foreign-key="RSC_PROFAM_FK"/>
	    <many-to-one name="iniciacion"  		 column="PRO_CODINI" 	 class="org.ibit.rol.sac.model.Iniciacion" foreign-key="RSC_PROINI_FK"/>
        <many-to-one name="servicioResponsable"  column="PRO_CODUNA_SERV" foreign-key="RSC_PRO_CODUNA_SERV_FK"/>
        <many-to-one name="silencio" 			 column="PRO_CODSIL" class="org.ibit.rol.sac.model.SilencioAdm" foreign-key="RSC_PRO_CODSIL_FK"/>
		<many-to-one name="lopdLegitimacion" 	 column="PRO_CODLEG" class="org.ibit.rol.sac.model.LopdLegitimacion" cascade="none"  foreign-key="RSC_PRO_CODLEG_FK"/>



        <set name="normativas" cascade="none" table="RSC_PRONOR" lazy="true">
            <cache usage="read-write"/>
            <key column="PRN_CODPRO" foreign-key="RSC_PRNPRO_FK"/>
            <many-to-many class="org.ibit.rol.sac.model.Normativa" column="PRN_CODNOR"  foreign-key="RSC_PRNNOR_FK"/>
        </set>

        <list name="tramites" cascade="delete" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="TRA_CODPRO" foreign-key="RSC_TRAPRO_FK"/>
            <index column="TRA_ORDEN"/>
            <one-to-many class="org.ibit.rol.sac.model.Tramite"/>
        </list>

        <list name="documentos" inverse="true" lazy="true">
            <!--
            	amartin 2014/04/25: se ha desactivado esta caché al dar problemas con la ordenación de los documentos asociados al procedimiento
            	(al reordenar documentos los valores en la BD cambiaban correctamente pero Hibernate seguía ofreciendo valores cacheados).
            	En Ficha.hbm.xml hay un list de documentos con esta misma configuración, con la caché activada, y no da problemas.

            	Desconozco el motivo.
             -->
            <!-- <cache usage="read-write"/> -->
            <key column="DOC_CODPRO" foreign-key="RSC_DOCPRO_FK"/>
            <index column="DOC_ORDEN"/>
            <one-to-many class="org.ibit.rol.sac.model.Documento"/>
        </list>

        <set name="materias" cascade="none" lazy="true" table="RSC_PROMAT">
            <cache usage="read-write"/>
            <key column="PRM_CODPRO" foreign-key="RSC_PRMPRO_FK"/>
            <many-to-many class="org.ibit.rol.sac.model.Materia" column="PRM_CODMAT"  foreign-key="RSC_PRMMAT_FK"/>
        </set>

        <set name="publicosObjetivo" cascade="none" lazy="true" table="RSC_POBPRO">
            <cache usage="read-write"/>
            <key column="PPR_CODPRO" foreign-key="RSC_PPRPRO_FK"/>
            <many-to-many class="org.ibit.rol.sac.model.PublicoObjetivo" column="PPR_CODPOB"  foreign-key="RSC_PPRPOB_FK"/>
        </set>

        <set name="hechosVitalesProcedimientos" cascade="all" lazy="true" inverse="true">
            <cache usage="read-write"/>
            <key column="HVP_CODPRO" foreign-key="RSC_HVPPRO_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.HechoVitalProcedimiento"/>
        </set>

        <map name="traducciones" cascade="all" table="RSC_TRAPRO">
            <cache usage="read-write"/>
            <key column="TPR_CODPRO" foreign-key="RSC_TPRPRO_FK"/>
            <index column="TPR_CODIDI" type="string" length="2"/>
            <composite-element class="org.ibit.rol.sac.model.TraduccionProcedimientoLocal">
                <property name="nombre" length="256" column="TPR_NOMBRE"/>
                <property name="resolucion" type="text" column="TPR_RESOLUCION"/>
                <property name="notificacion" type="text" column="TPR_NOTIFICACION"/>
                <property name="resultat" type="text" column="TPR_RESULT"/>
                <property name="resumen"  type="text" column="TPR_RESUME"/>
                <property name="destinatarios" type="text" column="TPR_DESTIN"/>
                <property name="requisitos" type="text" column="TPR_REQUIS"/>
                <property name="plazos" type="text" column="TPR_PLAZOS"/>
                <property name="recursos" type="text" column="TPR_RECURS"/>
                <property name="observaciones" type="text" column="TPR_OBSERV"/>
                <property name="lugar"  type="text" column="TPR_LUGAR"/>
                <property name="lopdFinalidad"  type="text" column="TPR_LOPDFI"/>
                <property name="lopdDestinatario"  type="text" column="TPR_LOPDDS"/>
                <property name="lopdDerechos"  type="text" column="TPR_LOPDDR"/>
                <many-to-one name="lopdInfoAdicional" cascade="all" column="TPR_LOPDIA" foreign-key="RSC_TPRARC_FK"/>
            </composite-element>
        </map>

        <subclass name="org.ibit.rol.sac.model.ProcedimientoRemoto" discriminator-value="procedimientoRemoto">
            <property name="idExterno" column="PRR_IDEXTE"/>
            <property name="urlRemota" length="512" column="PRR_URLREM"/>
            <many-to-one name="administracionRemota" column="PRR_CODADM" foreign-key="RSC_PRRADM_FK" />
        </subclass>

    </class>

</hibernate-mapping>
<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC
        "-//Hibernate/Hibernate Mapping DTD//EN"
        "http://hibernate.sourceforge.net/hibernate-mapping-2.0.dtd">

<hibernate-mapping>

	<class name="org.ibit.rol.sac.model.UnidadAdministrativa" table="RSC_UNIADM" discriminator-value="unidadAdministrativa" batch-size="100">
        <cache usage="read-write"/>

        <id name="id" unsaved-value="null" column="UNA_CODI">
            <generator class="sequence">
                <param name="sequence">RSC_SEQ_ALL</param>
            </generator>
        </id>

        <discriminator column="UNA_TYPE" type="string" length="64"/>

        <property name="businessKey" length="41" column="UNA_BUSKEY"/>
        <property name="claveHita" length="128" column="UNA_CLVHIT"/>
        <property name="dominio" length="256" column="UNA_DOMINI"/>
        <property name="orden" column="UNA_ORDEN"/>
        <property name="validacion" column="UNA_VALIDA"/>
        <property name="responsable" length="256" column="UNA_RESPON"/>
        <property name="telefono" length="64" column="UNA_TELEFO"/>
        <property name="fax" length="64" column="UNA_FAX"/>
        <property name="email" length="256" column="UNA_EMAIL"/>
        <property name="sexoResponsable" column="UNA_SEXRES"/>
        <property name="codigoEstandar" length="256" column="UNA_CODEST"/>
        <property name="numfoto1" column="UNA_NFOTO1"/>
        <property name="numfoto2" column="UNA_NFOTO2"/>
        <property name="numfoto3" column="UNA_NFOTO3"/>
        <property name="numfoto4" column="UNA_NFOTO4"/>                
	    <many-to-one name="fotop" cascade="all" column="UNA_FOTOP" foreign-key="RSC_UNAFOP_FK"/>
        <many-to-one name="fotog" cascade="all" column="UNA_FOTOG" foreign-key="RSC_UNAFOG_FK"/>
        <many-to-one name="logoh" cascade="all" column="UNA_LOGOH" foreign-key="RSC_UNALOH_FK"/>
        <many-to-one name="logov" cascade="all" column="UNA_LOGOV" foreign-key="RSC_UNALOV_FK"/>
        <many-to-one name="logos" cascade="all" column="UNA_LOGOS" foreign-key="RSC_UNALOS_FK"/>
        <many-to-one name="logot" cascade="all" column="UNA_LOGOT" foreign-key="RSC_UNALOT_FK"/>
        <many-to-one name="padre" cascade="none" column="UNA_CODUNA" foreign-key="RSC_UNAUNA_FK"/>

        <many-to-one name="espacioTerrit" column="UNA_CODESP" foreign-key="RSC_UNAESP_FK" />

        <list name="hijos" cascade="delete" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="UNA_CODUNA" foreign-key="RSC_UNAUNA_FK"/>
            <index column="UNA_ORDEN"/>
            <one-to-many class="org.ibit.rol.sac.model.UnidadAdministrativa"/>
        </list>

        <many-to-one name="tratamiento" cascade="none" column="UNA_CODTRT" foreign-key="RSC_UNATRT_FK"/>

        <set name="edificios" cascade="none" inverse="true" table="RSC_UNAEDI" lazy="true" order-by="UNE_CODEDI">
            <cache usage="read-write"/>
            <key column="UNE_CODUNA" foreign-key="RSC_UNEUNA_FK"/>
            <many-to-many class="org.ibit.rol.sac.model.Edificio" column="UNE_CODEDI" foreign-key="RSC_UNEEDI_FK" />
        </set>

        <set name="personal" cascade="none" inverse="true" lazy="true" order-by="PER_NOMBRE">
            <key column="PER_CODUNA" foreign-key="RSC_PERUNA_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.Personal"/>
        </set>

        <set name="normativas" cascade="none" inverse="true" lazy="true" order-by="NOR_FECHA">
            <cache usage="read-write"/>
            <key column="NOR_CODUNA" foreign-key="RSC_NORUNA_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.Normativa"/>
        </set>

        <set name="procedimientos" cascade="none" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="PRO_CODUNA" foreign-key="RSC_PROUNA_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.ProcedimientoLocal"/>
        </set>

		<set name="tramites" cascade="none" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="TRA_ORGCOMP" foreign-key="RSC_ORGCOMP_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.Tramite"/>
        </set>

        <set name="usuarios" cascade="none" table="RSC_UNAUSU" lazy="true">
            <key column="UNU_CODUNA" foreign-key="RSC_UNUUNA_FK"/>
            <many-to-many class="org.ibit.rol.sac.model.Usuario" column="UNU_CODUSU" foreign-key="RSC_UNUUSU_FK"/>
        </set>

        <set name="todasfichas" order-by="FUA_ORDEN" cascade="none" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="FUA_CODUNA" foreign-key="RSC_FUAUNA_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.FichaUA"/>
        </set>

        <list name="fichasUA" cascade="all" inverse="true" lazy="true">
            <cache usage="read-write"/>
            <key column="FUA_CODUNA" foreign-key="RSC_FUAUNA_FK"/>
            <index column="FUA_ORDEN"/>
            <one-to-many class="org.ibit.rol.sac.model.FichaUA"/>
        </list>

        <set name="unidadesMaterias" cascade="none" lazy="true" inverse="true" >
            <cache usage="read-write"/>
            <key column="UNM_CODUNA" foreign-key="RSC_UNMUNA_FK"/>
            <one-to-many class="org.ibit.rol.sac.model.UnidadMateria"/>
        </set>

		<map name="traducciones" cascade="all" table="RSC_TRAUNA" batch-size="200">
            <cache usage="read-write"/>
            <key column="TUN_CODUNA" foreign-key="RSC_TUNUNA_FK"/>
            <index column="TUN_CODIDI" type="string" length="2"/>
            <composite-element class="org.ibit.rol.sac.model.TraduccionUA">
                <property name="nombre" length="256" column="TUN_NOMBRE"/>
                <property name="presentacion" length="4000" column="TUN_PRESEN"/>
                <property name="abreviatura" length="64" column="TUN_ABREVI"/>
                <property name="url" length="256" column="TUN_URL" />
                <property name="cvResponsable" type="text" column="TUN_CVRESP" />
            </composite-element>
        </map>

        <subclass name="org.ibit.rol.sac.model.UnidadAdministrativaRemota" discriminator-value="unidadRemota">

            <property name="idExterno" column="UNR_IDEXTE"/>
            <property name="urlRemota" length="512" column="UNR_URLREM"/>
            <many-to-one name="administracionRemota" column="UNR_CODADM" foreign-key="RSC_UNRADM_FK" />
        </subclass>
        
    </class>

    <query name="unidades.root">
        <![CDATA[select ua from UnidadAdministrativa as ua where ua.padre is null order by ua.orden]]>
    </query>

    <query name="unidades.root.count">
        <![CDATA[select count(ua) from UnidadAdministrativa as ua where ua.padre is null]]>
    </query>

    <query name="unidades.byname">
        <![CDATA[select ua from UnidadAdministrativa as ua, trad in ua.traducciones where trad.nombre = :nombre]]>
    </query>
    
	<query name="fichasBySeccionInUA">
        <![CDATA[select new org.ibit.rol.sac.model.dto.FichaDTO(ficha.id, trad.titulo) from FichaResumenUA as fichaUA, FichaResumen as ficha, ficha.traducciones as trad  where index(trad) = :idioma and fichaUA.idUa = :idUA and fichaUA.idSeccio = :idSeccion and fichaUA.ficha.id = ficha.id and ficha.validacion = :validacion and (ficha.fechaCaducidad > sysdate or ficha.fechaCaducidad is null) and (ficha.fechaPublicacion > sysdate or ficha.fechaPublicacion is null)  order by fichaUA.orden asc, ficha.fechaActualizacion desc]]>
    </query>
    
    	<query name="fichasUABySeccionInUA">
        <![CDATA[select fichaUA from FichaResumenUA as fichaUA, FichaResumen as ficha, ficha.traducciones as trad  where index(trad) = :idioma and fichaUA.idUa = :idUA and fichaUA.idSeccio = :idSeccion and fichaUA.ficha.id = ficha.id and ficha.validacion = :validacion and (ficha.fechaCaducidad > sysdate or ficha.fechaCaducidad is null) and (ficha.fechaPublicacion > sysdate or ficha.fechaPublicacion is null)  order by fichaUA.orden asc, ficha.fechaActualizacion desc]]>
    </query>

</hibernate-mapping>